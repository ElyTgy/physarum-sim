<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Physarum Map Router ‚Äî Cities & Light Masks</title>
  <link rel="stylesheet" href="css/styles.css">
</head>
<body>
  <div id="wrap">
    <div id="cwrap">
      <canvas id="map"></canvas>
      <canvas id="sim"></canvas>
      <div id="hud">
        <div class="row" style="gap:8px;margin-bottom:6px;">
          <span class="tag legend"><span class="dot tube"></span> Tubes</span>
          <span class="tag legend"><span class="dot food"></span> Food</span>
          <span class="tag legend"><span class="dot repel"></span> Repellent</span>
          <span class="tag legend"><span class="dot city"></span> City</span>
          <span class="tag legend"><span class="dot mask"></span> Light Mask</span>
        </div>
        <div class="row">
          <span class="tag">Brush: <b id="brushName">Food</b></span>
          <span class="tag">Deposit <b id="depositVal">1.5</b></span>
          <span class="tag">A: <b class="kbd" id="aLed">OFF</b></span>
          <span class="tag">B: <b class="kbd" id="bLed">OFF</b></span>
        </div>
      </div>
      <div id="attr" hidden>Map data ¬© OpenStreetMap contributors</div>
    </div>
    <div id="side">
      <div id="resizeHandle"></div>
      <h1>Physarum Map Router</h1>
      <div class="muted">Load a map image, place <b>cities</b> (attractors) and draw <b>light masks</b> (avoid zones). The slime adapts and grows an efficient transport network.</div>
      <div class="row" style="margin-top:10px;">
        <button id="backToMapBtn" style="background: var(--muted); color: var(--bg);">‚Üê Back to Map Selection</button>
      </div>

      <h2>How it works</h2>
      <div class="card help">
        <p>Thousands of agent particles wander, sampling a chemo field = (trail + food√óweight ‚àí repellent√óweight). They turn toward stronger values, move, and deposit trail. Fields diffuse & evaporate each frame. When trail density crosses a threshold, we render it as tubes.</p>
        <p>Load a map. Draw <b>light masks</b> to repel growth in selected areas, or <b>bake</b> repellent from bright map regions. Place <b>cities</b> to feed the network and watch it adapt.</p>
      </div>

      <h2>Controls</h2>
      <div class="card help">
        <div>üñ±Ô∏è Hold <b>Left Mouse</b> (or press <b>A</b>) to paint. Hold <b>B</b> while painting for <b>Repellent</b>. Tap <b>B</b> to toggle brush.</div>
        <div>üèôÔ∏è Press <b>C</b> then click to place a city; press <b>D</b> then click to delete one.</div>
        <div>üåì Press <b>M</b> to start/finish drawing a polygon <b>Light Mask</b>; <b>Enter</b> to close, <b>Esc</b> to cancel.</div>
        <div>‚èØÔ∏è Space: pause/resume ‚Ä¢ <b>R</b>: reset ‚Ä¢ <b>H</b>: hide/show HUD</div>
      </div>

      <h2>Session</h2>
      <div class="card">
        <div class="metrics">
          <div class="metric"><label>Connected Cities</label><div><b id="connected">0 / 0</b></div></div>
          <div class="metric"><label>Active Tube Length</label><div><b id="tubeLen">0</b> cells</div></div>
          <div class="metric"><label>Time</label><div><b id="timeSec">0.0s</b></div></div>
          <div class="metric"><label>Best Connect-All</label><div><b id="bestTime">‚Äî</b></div></div>
        </div>
        <div class="row" style="margin-top:10px; gap:8px; flex-wrap:wrap;">
          <button id="resetBtn">Reset</button>
          <button id="togglePauseBtn">Pause</button>
        </div>
      </div>

      <h2>Light Masks</h2>
      <div class="card">
        <div class="row"><button id="startMaskBtn">Start Mask (M)</button><button id="finishMaskBtn">Finish</button></div>
        <div class="row"><label>Mask Strength / frame</label><input id="maskStrength" type="range" min="0.00" max="0.10" value="0.05" step="0.005"></div>
        <div class="row"><label><input id="showMasks" type="checkbox" checked> Show mask outlines</label><span></span></div>
        <div class="maskList" id="maskList"></div>
      </div>

      <h2>Brush & Agents</h2>
      <div class="card">
        <div class="row"><label>Deposit (Dial)</label><input id="deposit" type="range" min="0.2" max="5" value="1.5" step="0.1"></div>
        <div class="row"><label>Brush Radius</label><input id="radius" type="range" min="2" max="30" value="10" step="1"></div>
        <div class="row"><label>Agents</label><input id="agents" type="range" min="1000" max="15000" value="6000" step="500"></div>
        <div class="grid2">
          <button id="brushFood" class="primary">Food</button>
          <button id="brushRepel">Repellent</button>
        </div>
      </div>

      <h2>Fields</h2>
      <div class="card">
        <div class="row"><label>Tube Threshold</label><input id="tubeThresh" type="range" min="0.02" max="0.6" value="0.15" step="0.01"></div>
        <div class="row"><label>Trail Evaporation</label><input id="evap" type="range" min="0.92" max="0.999" value="0.98" step="0.001"></div>
        <div class="row"><label>Trail Diffusion</label><input id="diff" type="range" min="0" max="0.45" value="0.16" step="0.01"></div>
        <div class="row"><label>Food Weight</label><input id="wFood" type="range" min="0" max="3" value="1.2" step="0.1"></div>
        <div class="row"><label>Repel Weight</label><input id="wRepel" type="range" min="0" max="5" value="2.2" step="0.1"></div>
      </div>

      <div class="muted" style="margin-top:8px;">Made for custom controllers: map your hardware buttons to keyboard <b>A</b> and <b>B</b>, or just use mouse/keys.</div>
    </div>
  </div>

  <script type="module" src="js/main.js"></script>
</body>
</html>
